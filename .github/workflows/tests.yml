name: Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode Version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: List available simulators
      run: |
        echo "=== Xcode version ==="
        xcodebuild -version
        echo "=== Available iOS Simulators ==="
        xcrun simctl list devices ios
        echo "=== Available destinations ==="
        xcodebuild -project Example/VoticeDemo/VoticeDemo.xcodeproj -scheme VoticeDemo -showdestinations

    - name: Build and Test Swift Package
      run: swift test --verbose

    - name: Build iOS Example
      run: |
        cd Example/VoticeDemo

        SIMULATOR_INFO=$(python3 - <<'PY'
import json
import subprocess
import sys

try:
    data = json.loads(subprocess.check_output([
        "xcrun", "simctl", "list", "devices", "available", "--json"
    ]))
except subprocess.CalledProcessError:
    sys.exit(0)

candidates = []
for runtime_identifier, devices in data.get("devices", {}).items():
    if "iOS" not in runtime_identifier:
        continue
    version_str = runtime_identifier.split("iOS-")[-1].replace("-", ".")
    try:
        version_tuple = tuple(int(part) for part in version_str.split("."))
    except ValueError:
        continue
    for device in devices:
        name = device.get("name", "")
        udid = device.get("udid")
        if not name.startswith("iPhone") or not udid:
            continue
        candidates.append((version_tuple, version_str, name, udid))

if not candidates:
    sys.exit(0)

candidates.sort(reverse=True)
version_tuple, version_str, name, udid = candidates[0]
print(f"{version_str}|{name}|{udid}")
PY
        )

        if [ -z "$SIMULATOR_INFO" ]; then
          echo "❌ No iPhone simulators found, trying generic platform"
          xcodebuild -project VoticeDemo.xcodeproj \
                     -scheme VoticeDemo \
                     -destination 'generic/platform=iOS Simulator' \
                     build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO
        else
          IOS_VERSION=$(echo "$SIMULATOR_INFO" | cut -d'|' -f1)
          DEVICE_NAME=$(echo "$SIMULATOR_INFO" | cut -d'|' -f2)
          DEVICE_UDID=$(echo "$SIMULATOR_INFO" | cut -d'|' -f3)

          echo "✅ Using simulator: $DEVICE_NAME (iOS $IOS_VERSION)"
          echo "   UDID: $DEVICE_UDID"

          xcodebuild -project VoticeDemo.xcodeproj \
                     -scheme VoticeDemo \
                     -destination "platform=iOS Simulator,id=$DEVICE_UDID" \
                     build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO
        fi